var RECYCLED_NODE=1,LAZY_NODE=2,TEXT_NODE=3,EMPTY_OBJ={},EMPTY_ARR=[],map=EMPTY_ARR.map,isArray=Array.isArray,defer="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:setTimeout,createClass=function(e){var n="";if("string"==typeof e)return e;if(isArray(e)&&e.length>0)for(var t,r=0;r<e.length;r++)""!==(t=createClass(e[r]))&&(n+=(n&&" ")+t);else for(var r in e)e[r]&&(n+=(n&&" ")+r);return n},merge=function(e,n){var t={};for(var r in e)t[r]=e[r];for(var r in n)t[r]=n[r];return t},batch=function(e){return e.reduce(function(e,n){return e.concat(n&&!0!==n?"function"==typeof n[0]?[n]:batch(n):0)},EMPTY_ARR)},isSameAction=function(e,n){return isArray(e)&&isArray(n)&&e[0]===n[0]&&"function"==typeof e[0]},shouldRestart=function(e,n){if(e!==n)for(var t in merge(e,n)){if(e[t]!==n[t]&&!isSameAction(e[t],n[t]))return!0;n[t]=e[t]}},patchSubs=function(e,n,t){for(var r,o,a=0,i=[];a<e.length||a<n.length;a++)r=e[a],o=n[a],i.push(o?!r||o[0]!==r[0]||shouldRestart(o[1],r[1])?[o[0],o[1],o[0](t,o[1]),r&&r[2]()]:r:r&&r[2]());return i},patchProperty=function(e,n,t,r,o,a){if("key"===n);else if("style"===n)for(var i in merge(t,r))t=null==r||null==r[i]?"":r[i],"-"===i[0]?e[n].setProperty(i,t):e[n][i]=t;else"o"===n[0]&&"n"===n[1]?((e.actions||(e.actions={}))[n=n.slice(2).toLowerCase()]=r)?t||e.addEventListener(n,o):e.removeEventListener(n,o):!a&&"list"!==n&&n in e?e[n]=null==r?"":r:null==r||!1===r||"class"===n&&!(r=createClass(r))?e.removeAttribute(n):e.setAttribute(n,r)},createNode=function(e,n,t){var r=e.props,o=e.type===TEXT_NODE?document.createTextNode(e.name):(t=t||"svg"===e.name)?document.createElementNS("http://www.w3.org/2000/svg",e.name,{is:r.is}):document.createElement(e.name,{is:r.is});for(var a in r)patchProperty(o,a,null,r[a],n,t);for(var i=0,l=e.children.length;i<l;i++)o.appendChild(createNode(e.children[i]=getVNode(e.children[i]),n,t));return e.node=o},getKey=function(e){return null==e?null:e.key},patch=function(e,n,t,r,o,a){if(t===r);else if(null!=t&&t.type===TEXT_NODE&&r.type===TEXT_NODE)t.name!==r.name&&(n.nodeValue=r.name);else if(null==t||t.name!==r.name)n=e.insertBefore(createNode(r=getVNode(r),o,a),n),null!=t&&e.removeChild(t.node);else{var i,l,c,u,d=t.props,f=r.props,s=t.children,p=r.children,y=0,h=0,v=s.length-1,N=p.length-1;for(var g in a=a||"svg"===r.name,merge(d,f))("value"===g||"selected"===g||"checked"===g?n[g]:d[g])!==f[g]&&patchProperty(n,g,d[g],f[g],o,a);for(;h<=N&&y<=v&&null!=(c=getKey(s[y]))&&c===getKey(p[h]);)patch(n,s[y].node,s[y],p[h]=getVNode(p[h++],s[y++]),o,a);for(;h<=N&&y<=v&&null!=(c=getKey(s[v]))&&c===getKey(p[N]);)patch(n,s[v].node,s[v],p[N]=getVNode(p[N--],s[v--]),o,a);if(y>v)for(;h<=N;)n.insertBefore(createNode(p[h]=getVNode(p[h++]),o,a),(l=s[y])&&l.node);else if(h>N)for(;y<=v;)n.removeChild(s[y++].node);else{g=y;for(var m={},E={};g<=v;g++)null!=(c=s[g].key)&&(m[c]=s[g]);for(;h<=N;)c=getKey(l=s[y]),u=getKey(p[h]=getVNode(p[h],l)),E[c]||null!=u&&u===getKey(s[y+1])?(null==c&&n.removeChild(l.node),y++):null==u||t.type===RECYCLED_NODE?(null==c&&(patch(n,l&&l.node,l,p[h],o,a),h++),y++):(c===u?(patch(n,l.node,l,p[h],o,a),E[u]=!0,y++):null!=(i=m[u])?(patch(n,n.insertBefore(i.node,l&&l.node),i,p[h],o,a),E[u]=!0):patch(n,l&&l.node,null,p[h],o,a),h++);for(;y<=v;)null==getKey(l=s[y++])&&n.removeChild(l.node);for(var g in m)null==E[g]&&n.removeChild(m[g].node)}}return r.node=n},propsChanged=function(e,n){for(var t in e)if(e[t]!==n[t])return!0;for(var t in n)if(e[t]!==n[t])return!0},getTextVNode=function(e){return"object"==typeof e?e:createTextVNode(e)},getVNode=function(e,n){return e.type===LAZY_NODE?((!n||!n.lazy||propsChanged(n.lazy,e.lazy))&&((n=getTextVNode(e.lazy.view(e.lazy))).lazy=e.lazy),n):e},createVNode=function(e,n,t,r,o,a){return{name:e,props:n,children:t,node:r,type:a,key:o}},createTextVNode=function(e,n){return createVNode(e,EMPTY_OBJ,EMPTY_ARR,n,void 0,TEXT_NODE)},recycleNode=function(e){return e.nodeType===TEXT_NODE?createTextVNode(e.nodeValue,e):createVNode(e.nodeName.toLowerCase(),EMPTY_OBJ,map.call(e.childNodes,recycleNode),e,void 0,RECYCLED_NODE)};export var Lazy=function(e){return{lazy:e,type:LAZY_NODE}};export var h=function(e,n){for(var t,r=[],o=[],a=arguments.length;a-- >2;)r.push(arguments[a]);for(;r.length>0;)if(isArray(t=r.pop()))for(a=t.length;a-- >0;)r.push(t[a]);else!1===t||!0===t||null==t||o.push(getTextVNode(t));return n=n||EMPTY_OBJ,"function"==typeof e?e(n,o):createVNode(e,n,o,void 0,n.key)};export var app=function(e){var n={},t=!1,r=e.view,o=e.node,a=o&&recycleNode(o),i=e.subscriptions,l=[],c=function(e){d(this.actions[e.type],e)},u=function(e){return n!==e&&(n=e,i&&(l=patchSubs(l,batch([i(n)]),d)),r&&!t&&defer(f,t=!0)),n},d=(e.middleware||function(e){return e})(function(e,t){return"function"==typeof e?d(e(n,t)):isArray(e)?"function"==typeof e[0]||isArray(e[0])?d(e[0],"function"==typeof e[1]?e[1](t):e[1]):(batch(e.slice(1)).map(function(e){e&&e[0](d,e[1])},u(e[0])),n):u(e)}),f=function(){t=!1,o=patch(o.parentNode,o,a,a=getTextVNode(r(n)),c)};d(e.init)};